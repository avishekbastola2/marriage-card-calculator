<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Nepal Marriage Tracker</title>

<style>
:root { --bg:#0f172a; --panel:#1e293b; --accent:#6366f1; --win:#22c55e; --loss:#ef4444; --text:#f1f5f9; }
body { background:var(--bg); color:var(--text); margin:0; padding:20px; font-family:sans-serif; }

.center-box {
    max-width: 420px;
    margin: 40px auto;
    background: var(--panel);
    padding: 25px;
    border-radius: 12px;
    text-align: center;
    border: 1px solid #334155;
}

input, button, select {
    font-size: 16px;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #475569;
}

button {
    cursor: pointer;
    margin-top: 10px;
    width: 100%;
    font-weight: bold;
}

.btn-primary { background: var(--accent); color: white; border: none; }
.btn-add { background: var(--win); color: white; border: none; }
.btn-danger { background: var(--loss); color: white; border: none; }

.player-input-row { margin-bottom: 8px; }

.table-wrap { overflow-x:auto; margin-top:20px; }
table { width:100%; border-collapse:collapse; min-width:900px; }
th, td { padding:8px; border:1px solid #334155; text-align:center; }
th { background:#334155; color:#9ca3af; }

.maal-input { width:50px; font-size:14px; font-weight:bold; text-align:center; }

.pos { color:var(--win); font-weight:bold; }
.neg { color:var(--loss); font-weight:bold; }
.footer-row { background:#000; border-top:4px solid var(--accent); font-size:18px; }

.flag {
    width: 90px;
    margin: 0 auto 15px auto;
    display: block;
}
</style>
</head>

<body>

<!-- GAME ID INPUT -->
<div id="user-setup" class="center-box">
    <img class="flag" src="https://upload.wikimedia.org/wikipedia/commons/9/9b/Flag_of_Nepal.png">
    <h2>Enter Game ID</h2>

    <input id="gameID" placeholder="Type Game ID">
    <button class="btn-primary" onclick="initUser()">Continue</button>
</div>

<!-- PLAYER SETUP -->
<div id="setup" class="center-box" style="display:none;">
    <h3>Player Setup</h3>

    <label>Rate:</label>
    <input type="number" id="rate" value="10">

    <div id="player-container">
        <div class="player-input-row"><input class="p-name" placeholder="Player 1"></div>
        <div class="player-input-row"><input class="p-name" placeholder="Player 2"></div>
    </div>

    <button class="btn-add" onclick="addPlayerField()">+ Add Player</button>
    <button class="btn-primary" onclick="startGame()">Start Game</button>
</div>

<!-- GAME AREA -->
<div id="game-area" style="display:none;">
    <div class="table-wrap">
        <table id="scoreTable"></table>
    </div>

    <button class="btn-add" onclick="addRow()">+ Next Round</button>
    <button class="btn-danger" onclick="location.reload()">New Game</button>
</div>

<script type="module">
/* ---------------- FIREBASE IMPORTS ---------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

/* ---------------- FIREBASE CONFIG ---------------- */
const firebaseConfig = {
    apiKey: "AIzaSyA_h1kas6HV-Lhk06sya2hsAMZmuQNAm9U",
    authDomain: "marriage-card-tracker-b9b13.firebaseapp.com",
    databaseURL: "https://marriage-card-tracker-b9b13-default-rtdb.firebaseio.com",
    projectId: "marriage-card-tracker-b9b13",
    storageBucket: "marriage-card-tracker-b9b13.firebasestorage.app",
    messagingSenderId: "798170869634",
    appId: "1:798170869634:web:3242fd686443a4f2c2699b"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ---------------- GLOBALS ---------------- */
let players = [];
let rate = 10;
let roundCount = 0;
let globalGameID = "";

/* ---------------- INIT USER ---------------- */
window.initUser = function () {
    const id = document.getElementById("gameID").value.trim();
    if (!id) { alert("Enter Game ID"); return; }

    globalGameID = id;

    const gameRef = ref(db, "games/" + id);

    get(gameRef).then(snapshot => {
        if (snapshot.exists()) {
            if (confirm("Previous game found. Continue?")) {
                loadExistingGame(snapshot.val());
                document.getElementById("user-setup").style.display = "none";
                document.getElementById("game-area").style.display = "block";
            } else {
                showPlayerSetup();
            }
        } else {
            showPlayerSetup();
        }
    });
};

/* ---------------- SHOW PLAYER SETUP ---------------- */
function showPlayerSetup() {
    document.getElementById("user-setup").style.display = "none";
    document.getElementById("setup").style.display = "block";
}

/* ---------------- ADD PLAYER FIELD ---------------- */
window.addPlayerField = function () {
    const container = document.getElementById("player-container");
    if (container.children.length >= 5) {
        alert("Max 5 players allowed");
        return;
    }
    const div = document.createElement("div");
    div.className = "player-input-row";
    div.innerHTML = `<input class="p-name" placeholder="Player ${container.children.length + 1}">`;
    container.appendChild(div);
};

/* ---------------- START GAME ---------------- */
window.startGame = function () {
    rate = Number(document.getElementById("rate").value) || 10;

    players = [];
    document.querySelectorAll(".p-name").forEach(i => {
        if (i.value.trim()) players.push(i.value.trim());
    });

    if (players.length < 2) return alert("Enter at least 2 players!");

    document.getElementById("setup").style.display = "none";
    document.getElementById("game-area").style.display = "block";

    initTable();
    addRow();
};

/* ---------------- INIT TABLE ---------------- */
function initTable() {
    let table = document.getElementById("scoreTable");

    let head = `<thead><tr><th>RD</th><th>WINNER</th>`;
    players.forEach(p => head += `<th colspan="3">${p}</th>`);
    head += `<th>TOTAL MAAL</th></tr>`;

    let sub = `<tr><td></td><td></td>`;
    players.forEach(() => sub += `<td>M</td><td>S</td><td>Cash</td>`);
    sub += `<td></td></tr></thead>`;

    let foot = `<tr class="footer-row"><td></td><td>Total</td>`;
    players.forEach(() => foot += `<td colspan="3" class="g-total">0</td>`);
    foot += `<td id="session-total-maal">0</td></tr>`;

    table.innerHTML = head + sub + `<tbody id="tableBody"></tbody>` + foot;
}

/* ---------------- ADD ROUND ---------------- */
window.addRow = function () {
    roundCount++;

    const tbody = document.getElementById("tableBody");
    const row = tbody.insertRow();
    row.id = `row-${roundCount}`;

    row.insertCell().innerText = roundCount;

    let winnerCell = row.insertCell();
    let select = `<select onchange="calc(${roundCount})"><option value="-1">Select</option>`;
    players.forEach((p, i) => select += `<option value="${i}">${p}</option>`);
    select += `</select>`;
    winnerCell.innerHTML = select;

    players.forEach((p, i) => {
        row.insertCell().innerHTML = `<input type="number" class="maal-input" value="0" min="0" oninput="calc(${roundCount})">`;
        row.insertCell().innerHTML = `<select onchange="calc(${roundCount})"><option value="yes">YES</option><option value="no">NO</option></select>`;
        row.insertCell().innerText = "0";
    });

    row.insertCell().innerText = "0";

    calc(roundCount);
};

/* ---------------- CALCULATE ---------------- */
window.calc = function (rNum) {
    const row = document.getElementById(`row-${rNum}`);
    const winner = Number(row.cells[1].querySelector("select").value);

    let totalMaal = 0;
    let stats = [];

    players.forEach((p, i) => {
        let m = Number(row.cells[2 + i*3].querySelector("input").value) || 0;
        let s = row.cells[3 + i*3].querySelector("select").value;
        if (s === "yes") totalMaal += m;
        stats.push({ m, s });
    });

    if (winner >= 0) {
        let othersTotal = 0;

        players.forEach((p, i) => {
            if (i === winner) return;

            let cash = (stats[i].s === "no") ?
                -(totalMaal + 10) * rate :
                ((stats[i].m * players.length) - (totalMaal + 3)) * rate;

            row.cells[4 + i*3].innerText = cash;
            row.cells[4 + i*3].className = cash >= 0 ? "pos" : "neg";
            othersTotal += cash;
        });

        let winCash = -othersTotal;
        row.cells[4 + winner*3].innerText = winCash;
        row.cells[4 + winner*3].className = winCash >= 0 ? "pos" : "neg";
    }

    row.cells[row.cells.length - 1].innerText = totalMaal;
    updateTotals();
    saveGame();
};

/* ---------------- UPDATE TOTALS ---------------- */
function updateTotals() {
    const tbody = document.getElementById("tableBody");

    players.forEach((p, i) => {
        let sum = 0;
        Array.from(tbody.rows).forEach(row => {
            sum += Number(row.cells[4 + i*3].innerText) || 0;
        });
        document.getElementsByClassName("g-total")[i].innerText = sum;
    });

    let sessionMaal = 0;
    Array.from(tbody.rows).forEach(row => {
        sessionMaal += Number(row.cells[row.cells.length - 1].innerText) || 0;
    });
    document.getElementById("session-total-maal").innerText = sessionMaal;
}

/* ---------------- SAVE TO FIREBASE ---------------- */
function saveGame() {
    const tbody = document.getElementById("tableBody");

    let rounds = [];
    Array.from(tbody.rows).forEach(row => {
        const win = Number(row.cells[1].querySelector("select").value);

        let data = {
            round: Number(row.cells[0].innerText),
            winner: win >= 0 ? players[win] : null,
            maal: [],
            seen: [],
            cash: [],
            totalMaal: Number(row.cells[row.cells.length - 1].innerText)
        };

        players.forEach((p, i) => {
            data.maal.push(Number(row.cells[2 + i*3].querySelector("input").value));
            data.seen.push(row.cells[3 + i*3].querySelector("select").value);
            data.cash.push(Number(row.cells[4 + i*3].innerText));
        });

        rounds.push(data);
    });

    const saveRef = ref(db, "games/" + globalGameID);
    set(saveRef, {
        rate: rate,
        players: players,
        rounds: rounds
    });
}

/* ---------------- LOAD PREVIOUS GAME ---------------- */
window.loadExistingGame = function (data) {
    players = data.players;
    rate = data.rate;

    document.getElementById("setup").style.display = "none";
    document.getElementById("game-area").style.display = "block";

    initTable();

    roundCount = 0;

    data.rounds.forEach(r => {
        addRow();
        const row = document.getElementById(`row-${r.round}`);

        row.cells[1].querySelector("select").value = players.indexOf(r.winner);

        players.forEach((p, i) => {
            row.cells[2 + i*3].querySelector("input").value = r.maal[i];
            row.cells[3 + i*3].querySelector("select").value = r.seen[i];
            row.cells[4 + i*3].innerText = r.cash[i];
        });

        row.cells[row.cells.length - 1].innerText = r.totalMaal;
        calc(r.round);
    });
};
</script>

</body>
</html>
